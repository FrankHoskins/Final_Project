<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <style>
      #map {
        height: 75%;
        width: 100%;

      }

      .mapLabel {
        color: Blue;
        font-family: 'Lato', sans-serif !important;
        font-size: 40px;
        font-weight: bold;
      }

      span {
        font-style: bold;
        font-size: 20px;
        font-family: ;
      }

      html, body {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body>
  	<br><br><br><br><br>
    <center><span>Weather Map - Past Hour</span></center>
    <br>
    <center><span><button id="btnRadar" type="button">Weather Radar</button><button id="btnTemp" type="button">Temperatures</button></span></center>
    <div id="map"></div>
    <script>

      const kckCoordinates = [39.1155,-94.6268]
      var map;
      var radarLoop;
      var radarTiles;
      var weatherMarkers = [];
      var http = new XMLHttpRequest();
      var getElement = document.getElementById.bind(document);

      function fetchTemperatures(coordinates) { // Supplies temperatures at all observation stations within supplied coordinates (Latitude,Longitude).
        if (typeof(coordinates) !== "string") { return "Invalid parameter - String Expected"; }
        http.open("get", "https://api.weather.gov/points/" + coordinates, false); http.send(null);

        let httpObj = JSON.parse(http.responseText);
        if (httpObj.status) { return "Invalid Coordinates - Expected Lat,Lng"; }

        let weatherMarkers = []
        http.open("get", httpObj.properties.forecastOffice, false); http.send(null);
        httpObj = JSON.parse(http.responseText);

        for (let i = 0; i < httpObj.approvedObservationStations.length; i++) {
          http.open("get", httpObj.approvedObservationStations[i], false); http.send(null);
          let tempObj = JSON.parse(http.responseText);
          let tempWeather = {}
          tempWeather["Name"] = tempObj.properties.name;
          tempWeather["Position"] = tempObj.geometry.coordinates;
          tempWeather["id"] = tempObj.properties.forecast.split("/").pop();

          http.open("get", "https://api.weather.gov/zones/forecast/" + tempWeather.id + "/observations?limit=1", false); http.send(null);
          tempObj = JSON.parse(http.responseText);

          tempWeather["Temperature"] = ((tempObj.features[0].properties.temperature.value * (9/5)) + 32).toString().slice(0,5) + "Â° F";
          tempWeather["Description"] = tempObj.features[0].properties.textDescription;
          weatherMarkers.push(tempWeather);

          console.log(i + "/" + httpObj.approvedObservationStations.length);
        }

        return weatherMarkers;
      }



      function initMap() {

      	var apiResponse;
      	var coordinates;
        var timestamps = [];
        var urlTemplate = "http://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/nexrad-n0q-{timestamp}/{zoom}/{x}/{y}.png" // Base Reflectivity Radar 

        for (let i = 10; i > 1; i--) { timestamps.push("900913-m" + i * 5 + "m"); };
        timestamps.push("900913-m05m"); timestamps.push("900913"); // 900913 - Newest Radar Image / 900913-m{minute}m - # minute(s) old radar image with max of 50 minutes

        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: kckCoordinates[0], lng: kckCoordinates[1]},
          zoom: 8, // Lower - Farther / Higher - Closer
          mapTypeId: 'terrain',
          draggable: false,
          disableDefaultUI: true
        });


        radarTiles = timestamps.map((timestamp) => {
          return new google.maps.ImageMapType({
            getTileUrl: function(tile, zoom) { 
              var tempURL = urlTemplate;
              tempURL = tempURL.replace("{timestamp}", timestamp);
              tempURL = tempURL.replace("{zoom}", zoom);
              tempURL = tempURL.replace("{x}", tile.x);
              tempURL = tempURL.replace("{y}", tile.y);
              return tempURL + "?" + (new Date()).getTime(); // Appends date to avoid caching issues
            },
            tileSize: new google.maps.Size(256,256),
            opacity: 0.6,
            name: 'WeatherRadar',
            isPng: true
          });
        });
      }

      function weatherRadar(map, layers) {
        map.overlayMapTypes.clear();
        for (let i = 0; i < weatherMarkers.length; i++) { weatherMarkers[i].setMap(null); }
        let counter = 0;
        radarLoop = setInterval(function() {
            map.overlayMapTypes.setAt("1", layers[counter]);
            counter = (counter + 1) % layers.length;
        }, 2000);
      }

      function plotTemperatures() {
        map.overlayMapTypes.clear(); clearInterval(radarLoop);

        if (weatherMarkers.length === 0) {
          var tempMarkers = fetchTemperatures(kckCoordinates.toString());

          for (let i = 0; i < tempMarkers.length; i++) {
            let marker = new google.maps.Marker({
              position: {lat: tempMarkers[i].Position[1], lng: tempMarkers[i].Position[0]},
              map: map,
              animation: google.maps.Animation.DROP,
              label: {
                text: tempMarkers[i].Temperature,
                color: "#3432a8",
                fontSize: "20px",
                fontWeight: "bold"
              },
              icon: {
                path: google.maps.SymbolPath.CIRCLE, scale: 0
              }
            })
            weatherMarkers.push(marker);
          }
        } else {
          for (let i = 0; i < weatherMarkers.length; i++) {
            weatherMarkers[i].setMap(map);
          }
        }
      }

      function showRadar() { weatherRadar(map, radarTiles); }

      getElement("btnRadar").onclick = showRadar;
      getElement("btnTemp").onclick = plotTemperatures;


    </script>
    <script src="https://maps.googleapis.com/maps/api/js?callback=initMap"
    async defer></script>
  </body>
</html>


